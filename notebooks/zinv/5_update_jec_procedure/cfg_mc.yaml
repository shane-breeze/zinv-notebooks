create_hdf_from_root:
    func: "zquery.analysis_functions:create_hdf_from_root"
    args:
        - tree: "Events"
          output:
              tree: "Event"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: ["name", "parent", "isdata", "xsection"]
          iterate_kwargs:
              branches: [
                  "run", "luminosityBlock", "event",
                  "Pileup_*", "PV_*",
                  "fixedGridRhoFastJet*",
                  "RawMET_*", "MET_*", "CaloMET_*", "TkMET_*", "PuppiMET_*",
                  "HLT_*", "Flag_*",
                  "genWeight", "Generator_*", "GenMET_*",
              ]
              entrysteps: 1_000_000
        - tree: "Events"
          output:
              tree: "Jet"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["Jet_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "Muon"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["Muon_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "Electron"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          outdir: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["Electron_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "Photon"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          outdir: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["Photon_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "Tau"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["Tau_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "IsoTrack"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["IsoTrack_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "GenPart"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["GenPart_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "GenDressedLepton"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["GenDressedLepton_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "LHEPart"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["LHEPart_*"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "LHEPdfWeight"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["LHEPdfWeight"]
              entrysteps: 1_000_000
              flatten: True
        - tree: "Events"
          output:
              tree: "LHEScaleWeight"
              direc: "/vols/cms/sdb15/Analysis/ZinvWidth/databases/hdf_from_nanoaod/2020/02_Feb/05_InitialDataFrames/MC"
          dataset:
              cfg: "/vols/build/cms/sdb15/phd/ZinvWidth/zinv-notebooks/notebooks/zinv/5_update_jec_procedure/datasets.yaml"
              keys: []
          iterate_kwargs:
              branches: ["LHEScaleWeight"]
              entrysteps: 1_000_000
              flatten: True
trigger_and_flag_checker:
    func: "zquery.analysis_functions:basic_eval"
    args:
        - input: "Event"
          evals:
              - "METTriggered = (HLT_PFMETNoMu90_PFMHTNoMu90_IDTight) | (HLT_PFMETNoMu100_PFMHTNoMu100_IDTight) | (HLT_PFMETNoMu110_PFMHTNoMu110_IDTight) | (HLT_PFMETNoMu120_PFMHTNoMu120_IDTight) | (HLT_PFMET170_NotCleaned) | (HLT_PFMET170_BeamHaloCleaned) | (HLT_PFMET170_HBHECleaned) | (HLT_PFMET170_HBHE_BeamHaloCleaned) | (HLT_MET75_IsoTrk50)"
              - "SingleMuonTriggered = (HLT_IsoMu24) | (HLT_IsoTkMu24)"
              - "SingleElectronTriggered = (HLT_Ele27_WPTight_Gsf) | (HLT_Ele115_CaloIdVT_GsfTrkIdT)"
              - "Flag_METFilters = (Flag_goodVertices) & (Flag_globalSuperTightHalo2016Filter) & (Flag_HBHENoiseFilter) & (Flag_HBHENoiseIsoFilter) & (Flag_EcalDeadCellTriggerPrimitiveFilter) & (Flag_BadPFMuonFilter)"
          output: "EventExtended"
query_leptons_and_photons:
    func: "zquery.analysis_functions:basic_query"
    args:
        - input: "Electron"
          output: "ElectronVeto"
          query: "(Electron_pt>10.) & (abs(Electron_eta)<2.5) & (Electron_cutBased>=1) & (Electron_convVeto) & (abs(Electron_dxy)<0.118) & (abs(Electron_dz)<0.822)"
        - input: "ElectronVeto"
          output: "ElectronSelection"
          query: "(Electron_pt>30.) & (abs(Electron_eta)<2.4) & (Electron_cutBased>=4) & (Electron_convVeto) & (((abs(Electron_eta)<=1.479) & (abs(Electron_dxy)<0.05) & (abs(Electron_dz)<0.1)) | ((abs(Electron_eta)>1.479) & (abs(Electron_dxy)<0.1) & (abs(Electron_dz)<0.2)))"
        - input: "Muon"
          output: "MuonVeto"
          query: "(Muon_pt>10.) & (abs(Muon_eta)<2.5) & (abs(Muon_pfRelIso04_all)<0.25) & (abs(Muon_dxy)<0.5) & (abs(Muon_dz)<1.0)"
        - input: "MuonVeto"
          output: "MuonSelection"
          query: "(Muon_pt>30.) & (abs(Muon_eta)<2.4) & (abs(Muon_pfRelIso04_all)<0.15) & (Muon_tightId>=1)"
        - input: "Photon"
          output: "PhotonVeto"
          query: "(Photon_pt>25.) & (abs(Photon_eta)<2.5) & (Photon_cutBased>=1) & (~Photon_pixelSeed)"
        - input: "PhotonVeto"
          output: "PhotonSelection"
          query: "(Photon_pt>165.) & (abs(Photon_eta)<1.45) & (Photon_cutBased>=3)"
isotrack_cross_cleaning:
    func: "zquery.analysis_functions:object_cross_cleaning"
    args:
        - input: "IsoTrack"
          output: "IsoTrackClean"
          columns: "IsoTrack_{}"
          distance: 0.4
          references:
              - table: "MuonVeto"
                columns: "Muon_{}"
              - table: "ElectronVeto"
                columns: "Electron_{}"
tau_cross_cleaning:
    func: "zquery.analysis_functions:object_cross_cleaning"
    args:
        - input: "Tau"
          columns: "Tau_{}"
          output: "TauClean"
          distance: 0.4
          references:
              - table: "MuonVeto"
                columns: "Muon_{}"
              - table: "ElectronVeto"
                columns: "Electron_{}"
query_taus:
    func: "zquery.analysis_functions:basic_query"
    args:
        - input: "TauClean"
          output: "TauVeto"
          query: "(Tau_pt>20.) & (abs(Tau_eta)<2.3) & (Tau_idMVAoldDM>=1)"
        - input: "TauVeto"
          output: "TauSelection"
          query: "(Tau_pt>40.) & (abs(Tau_eta)<2.3) & (Tau_idMVAoldDM>=8)"
calculate_metnox:
    func: "zquery.analysis_functions:shift_2dvector"
    kwargs:
        input: "EventExtended"
        output: "EventExtended"
        args:
        - variables: {"pt": "MET_pt", "phi": "MET_phi"}
          output_variables: {"pt": "METnoX_pt", "phi": "METnoX_phi"}
          shifters:
              - table: "MuonSelection"
                variables: {"pt": "Muon_pt", "phi": "Muon_phi"}
              - table: "ElectronSelection"
                variables: {"pt": "Electron_pt", "phi": "Electron_phi"}
        - variables: {"pt": "METnoX_pt", "phi": "METnoX_phi"}
          relative: True
          output_variables: {"pt": "METnoX_pt_sigmaJESUp", "phi": "METnoX_phi_sigmaJESUp"}
          shifters:
              - table: "Jet"
                variables: {"pt": "-Jet_pt_sigmaJESUp", "phi": "Jet_phi"}
        - variables: {"pt": "METnoX_pt", "phi": "METnoX_phi"}
          relative: True
          output_variables: {"pt": "METnoX_pt_sigmaJESDown", "phi": "METnoX_phi_sigmaJESDown"}
          shifters:
              - table: "Jet"
                variables: {"pt": "-Jet_pt_sigmaJESDown", "phi": "Jet_phi"}
        - variables: {"pt": "METnoX_pt", "phi": "METnoX_phi"}
          relative: True
          output_variables: {"pt": "METnoX_pt_sigmaJERUp", "phi": "METnoX_phi_sigmaJERUp"}
          shifters:
              - table: "Jet"
                variables: {"pt": "-Jet_pt_sigmaJERUp", "phi": "Jet_phi"}
        - variables: {"pt": "METnoX_pt", "phi": "METnoX_phi"}
          relative: True
          output_variables: {"pt": "METnoX_pt_sigmaJERDown", "phi": "METnoX_phi_sigmaJERDown"}
          shifters:
              - table: "Jet"
                variables: {"pt": "-Jet_pt_sigmaJERDown", "phi": "Jet_phi"}
copy_met_shifts:
    func: "zquery.analysis_functions:basic_eval"
    args:
        - input: "EventExtended"
          evals:
              - "METnoX_pt_sigmaUESUp = MET_pt_sigmaUESUp"
              - "METnoX_pt_sigmaUESDown = MET_pt_sigmaUESDown"
              - "METnoX_phi_sigmaUESUp = MET_phi_sigmaUESUp"
              - "METnoX_phi_sigmaUESDown = MET_phi_sigmaUESDown"
              - "Min4JetSelection_dphiMETnoX_sigmaJESUp = MET_phi_sigmaJESUp"
              - "Min4JetSelection_dphiMETnoX_sigmaJESDown = MET_phi_sigmaJESDown"
              - "Min4JetSelection_dphiMETnoX_sigmaJERUp = MET_phi_sigmaJERUp"
              - "Min4JetSelection_dphiMETnoX_sigmaJERDown = MET_phi_sigmaJERDown"
              - "Min4JetSelection_dphiMETnoX_sigmaUESUp = MET_phi_sigmaUESUp"
              - "Min4JetSelection_dphiMETnoX_sigmaUESDown = MET_phi_sigmaUESDown"
          output: "EventExtended"
calculate_jet_dphi_metnox:
    func: "zquery.analysis_functions:object_cross_dphi"
    args:
        - left: {table: "Jet", variable: "Jet_phi"}
          right: {table: "EventExtended", variable: "METnoX_phi"}
          output_variable: "Jet_dPhiMETnoX"
jet_cross_cleaning:
    func: "zquery.analysis_functions:object_cross_cleaning"
    args:
        - input: "Jet"
          output: "JetClean"
          columns: "Jet_{}"
          distance: 0.4
          references:
              - table: "MuonVeto"
                columns: "Muon_{}"
              - table: "ElectronVeto"
                columns: "Electron_{}"
              - table: "TauVeto"
                columns: "Tau_{}"
query_jets:
    func: "zquery.analysis_functions:basic_query"
    args:
        - input: "JetClean"
          output: "JetVeto"
          query: "Jet_jetId>=1"
        - input: "JetVeto"
          output: "JetSelection"
          query: "abs(Jet_eta)<2.4"
        - input: "JetVeto"
          output: "JetBVeto"
          query: "Jet_btagCSVV2>0.8484"
        - input: "JetSelection"
          output: "JetBSelection"
          query: "Jet_btagCSVV2>0.8484"
        - input: "JetVeto"
          output: "JetFwdSelection"
          query: "abs(Jet_eta)>=2.4"
calculate_mindphi:
    func: "zquery.analysis_functions:mindphi"
    args:
        - input: {table: "JetSelection", variable: "Jet_dPhiMETnoX"}
          nobj: 4
          output: {table: "EventExtended", variable: "Min4JetSelection_dphiMETnoX"}
calculate_dcalomet:
    func: "zquery.analysis_functions:basic_eval"
    args:
        - input: "EventExtended"
          evals:
              - "MET_dptCaloMET = abs(MET_pt - CaloMET_pt)/METnoX_pt"
              - "MET_dptCaloMET_sigmaJESUp = abs(MET_pt + METnoX_pt_sigmaJESUp - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaJESUp) - MET_dptCaloMET"
              - "MET_dptCaloMET_sigmaJESDown = abs(MET_pt + METnoX_pt_sigmaJESDown - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaJESDown) - MET_dptCaloMET"
              - "MET_dptCaloMET_sigmaJERUp = abs(MET_pt + METnoX_pt_sigmaJERUp - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaJERUp) - MET_dptCaloMET"
              - "MET_dptCaloMET_sigmaJERDown = abs(MET_pt + METnoX_pt_sigmaJERDown - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaJERDown) - MET_dptCaloMET"
              - "MET_dptCaloMET_sigmaUESUp = abs(MET_pt + METnoX_pt_sigmaUESUp - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaUESUp) - MET_dptCaloMET"
              - "MET_dptCaloMET_sigmaUESDown = abs(MET_pt + METnoX_pt_sigmaUESDown - CaloMET_pt)/(METnoX_pt + METnoX_pt_sigmaUESDown) - MET_dptCaloMET"
          output: "EventExtended"
calculate_sigmoid_weights:
    func: "zquery.analysis_functions:weight_sigmoid"
    args:
        - input: {"table": "EventExtended", "variable": "METnoX_pt", "variations": ["JES", "JER", "UES"]}
          cut: "200."
          output_table: "EventExtended"
        - input: {"table": "EventExtended", "variable": "MET_dptCaloMET", "variations": ["JES", "JER", "UES"]}
          cut: "0.5"
          output_table: "EventExtended"
        - input: {"table": "JetSelection", "variable": "Jet_pt", "variations": ["JES", "JER"]}
          cut: "40."
          output_table: "JetSelection"
        - input: {"table": "JetSelection", "variable": "Jet_pt", "variations": ["JES", "JER"]}
          cut: "200."
          output_table: "JetSelection"
